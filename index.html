<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é«˜é“å¹²æ‰°ä¸‹æ°´é¸Ÿè¡Œä¸ºè§‚æµ‹è®°å½•ç³»ç»Ÿ</title>
    <style>
        /* åŸºæœ¬æ ·å¼ */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Microsoft YaHei', sans-serif;
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            touch-action: pan-y;
        }
        
        body {
            background-color: #f0f8ff;
            color: #333;
            line-height: 1.6;
            padding: 10px;
            max-width: 100%;
            overflow-x: hidden;
            -webkit-text-size-adjust: 100%;
            -webkit-overflow-scrolling: touch;
        }
        
        .header {
            background: linear-gradient(135deg, #1e5799 0%, #207cca 100%);
            color: white;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 20px;
            text-align: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .header h1 {
            font-size: 1.6rem;
            margin-bottom: 5px;
        }
        
        .header p {
            font-size: 0.9rem;
            opacity: 0.9;
        }
        
        /* æ ‡ç­¾é¡µæ ·å¼ */
        .tab-container {
            display: flex;
            background-color: #e6f2ff;
            border-radius: 10px;
            margin-bottom: 20px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .tab {
            flex: 1;
            text-align: center;
            padding: 15px 5px;
            font-weight: 600;
            font-size: 0.95rem;
            color: #1e5799;
            cursor: pointer;
            transition: all 0.3s ease;
            -webkit-user-select: none;
            user-select: none;
        }
        
        .tab.active {
            background-color: #1e5799;
            color: white;
        }
        
        .tab::before {
            display: inline-block;
            margin-right: 6px;
            font-size: 1rem;
        }
        
        .tab[data-tab="observation"]::before {
            content: "ğŸ‘ï¸";
        }
        
        .tab[data-tab="interference"]::before {
            content: "ğŸš†";
        }
        
        .tab[data-tab="behavior"]::before {
            content: "ğŸ¦";
        }
        
        /* é¢æ¿æ ·å¼ */
        .panel {
            display: none;
            background-color: white;
            border-radius: 12px;
            padding: 20px 15px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
        }
        
        .panel.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .section-title {
            color: #1e5799;
            border-bottom: 2px solid #e6f2ff;
            padding-bottom: 10px;
            margin-bottom: 20px;
            font-size: 1.4rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .section-title::before {
            margin-right: 10px;
        }
        
        #observation-panel .section-title::before {
            content: "ğŸ‘ï¸";
        }
        
        #interference-panel .section-title::before {
            content: "ğŸš†";
        }
        
        #behavior-panel .section-title::before {
            content: "ğŸ¦";
        }
        
        /* è°ƒç ”è®°å½•åˆ—è¡¨æ ·å¼ */
        .survey-list {
            margin-bottom: 25px;
        }
        
        .survey-item {
            background-color: #f8faff;
            border-left: 5px solid #1e5799;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }
        
        .survey-info {
            flex-grow: 1;
        }
        
        .survey-site {
            display: inline-block;
            background-color: #e6f2ff;
            color: #1e5799;
            padding: 3px 10px;
            border-radius: 20px;
            font-size: 0.85rem;
            margin-bottom: 5px;
        }
        
        .survey-date {
            color: #666;
            font-size: 0.9rem;
            margin-bottom: 5px;
        }
        
        .survey-entries-count {
            font-size: 0.85rem;
            color: #888;
        }
        
        /* æŒ‰é’®æ ·å¼ */
        .delete-btn {
            background-color: #ff6b6b;
            color: white;
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            margin-left: 10px;
            transition: background-color 0.3s;
            -webkit-user-select: none;
            user-select: none;
        }
        
        .delete-btn:hover, .delete-btn:active {
            background-color: #ff5252;
        }
        
        .export-btn {
            background-color: #28a745;
            color: white;
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            margin-left: 10px;
            transition: background-color 0.3s;
            -webkit-user-select: none;
            user-select: none;
        }
        
        .export-btn:hover, .export-btn:active {
            background-color: #218838;
        }
        
        .add-survey-btn {
            background-color: #1e5799;
            color: white;
            border: none;
            padding: 14px;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            width: 100%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.3s;
            margin-bottom: 20px;
            -webkit-user-select: none;
            user-select: none;
        }
        
        .add-survey-btn:hover, .add-survey-btn:active {
            background-color: #164c8a;
        }
        
        .add-survey-btn::before {
            content: "â•";
            margin-right: 10px;
            font-size: 1.2rem;
        }
        
        .export-section-btn {
            background-color: #28a745;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 0.95rem;
            cursor: pointer;
            transition: background-color 0.3s;
            display: inline-flex;
            align-items: center;
            margin-left: 10px;
            margin-top: 5px;
            margin-bottom: 5px;
            -webkit-user-select: none;
            user-select: none;
        }
        
        .export-section-btn::before {
            content: "ğŸ“¤";
            margin-right: 8px;
        }
        
        .export-section-btn:hover, .export-section-btn:active {
            background-color: #218838;
        }
        
        .form-container {
            background-color: #f8faff;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: none;
        }
        
        .form-container.active {
            display: block;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            color: #1e5799;
        }
        
        .form-control {
            width: 100%;
            padding: 12px;
            border: 1px solid #d1e3ff;
            border-radius: 8px;
            font-size: 1rem;
            background-color: white;
            -webkit-appearance: none;
            appearance: none;
        }
        
        .form-control:focus {
            outline: none;
            border-color: #1e5799;
            box-shadow: 0 0 0 3px rgba(30, 87, 153, 0.1);
        }
        
        .time-btn {
            background-color: #4caf50;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 0.95rem;
            cursor: pointer;
            transition: background-color 0.3s;
            display: inline-flex;
            align-items: center;
            -webkit-user-select: none;
            user-select: none;
        }
        
        .time-btn::before {
            content: "â±ï¸";
            margin-right: 8px;
        }
        
        .time-btn:hover, .time-btn:active {
            background-color: #3d8b40;
        }
        
        /* è¡Œä¸ºæŒ‰é’®å®¹å™¨ - ä¼˜åŒ–ä¸º3åˆ—å¸ƒå±€ */
        .behavior-btn-container {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-bottom: 20px;
        }
        
        /* è¡Œä¸ºæŒ‰é’® - ç¼©å°å°ºå¯¸ */
        .behavior-btn {
            background-color: #1e5799;
            color: white;
            border: none;
            padding: 12px 6px;
            border-radius: 8px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            -webkit-user-select: none;
            user-select: none;
            touch-action: manipulation;
            min-height: 70px;
        }
        
        .behavior-btn:hover, .behavior-btn:active {
            background-color: #164c8a;
            transform: translateY(-1px);
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.1);
        }
        
        .behavior-btn.distribution {
            background-color: #2a9d8f;
        }
        
        .behavior-btn.distribution:hover, .behavior-btn.distribution:active {
            background-color: #228176;
        }
        
        .behavior-btn::before {
            font-size: 1.1rem;
            margin-bottom: 5px;
        }
        
        /* è®¾ç½®æ¯ä¸ªè¡Œä¸ºæŒ‰é’®çš„å›¾æ ‡ */
        .behavior-btn[data-behavior="è§…é£Ÿ"]::before { content: "ğŸ´"; }
        .behavior-btn[data-behavior="è¿›é£Ÿ"]::before { content: "ğŸ½ï¸"; }
        .behavior-btn[data-behavior="è§…é£ŸæˆåŠŸ"]::before { content: "âœ…"; }
        .behavior-btn[data-behavior="é¥®æ°´"]::before { content: "ğŸ’§"; }
        .behavior-btn[data-behavior="èµ·é£"]::before { content: "âœˆï¸"; }
        .behavior-btn[data-behavior="æƒŠé£"]::before { content: "ğŸƒ"; }
        .behavior-btn[data-behavior="é™è½"]::before { content: "ğŸ›¬"; }
        .behavior-btn[data-behavior="ç†ç¾½"]::before { content: "ğŸª¶"; }
        .behavior-btn[data-behavior="äº¤æµé¸£å«"]::before { content: "ğŸ’¬"; }
        .behavior-btn[data-behavior="äº’åŠ¨è¡Œä¸ºï¼ˆç§¯æï¼‰"]::before { content: "ğŸ‘"; }
        .behavior-btn[data-behavior="äº’åŠ¨è¡Œä¸ºï¼ˆæ¶ˆæï¼‰"]::before { content: "ğŸ‘"; }
        .behavior-btn[data-behavior="è­¦ç¤ºé¸£å«"]::before { content: "âš ï¸"; }
        .behavior-btn[data-behavior="å¼ æœ›ï¼ˆ3sï¼‰"]::before { content: "ğŸ‘€"; }
        .behavior-btn[data-behavior="è­¦æˆ’"]::before { content: "ğŸ›¡ï¸"; }
        .behavior-btn[data-behavior="åŠ é€Ÿç§»åŠ¨"]::before { content: "âš¡"; }
        .behavior-btn[data-behavior="é›†ç¾¤"]::before { content: "ğŸ‘¥"; }
        .behavior-btn[data-behavior="åˆ†æ•£"]::before { content: "ğŸ‘¤"; }
        .behavior-btn[data-behavior="å½’å²¸"]::before { content: "â¬…ï¸"; }
        .behavior-btn[data-behavior="ç¦»å²¸"]::before { content: "â¡ï¸"; }
        .behavior-btn[data-behavior="ä½ç½®å˜æ›´0-30"]::before { content: "â†”ï¸0-30"; }
        .behavior-btn[data-behavior="ä½ç½®å˜æ›´30-60"]::before { content: "â†”ï¸30-60"; }
        .behavior-btn[data-behavior="ä½ç½®å˜æ›´60-100"]::before { content: "â†”ï¸60-100"; }
        .behavior-btn[data-behavior="ä½ç½®å˜æ›´100-150"]::before { content: "â†”ï¸100-150"; }
        .behavior-btn[data-behavior="ä½ç½®å˜æ›´150-250"]::before { content: "â†”ï¸150-250"; }
        
        .entry-list {
            margin-top: 20px;
        }
        
        .entry-item {
            background-color: white;
            border: 1px solid #e6f2ff;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }
        
        .entry-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 1px dashed #e6f2ff;
        }
        
        .entry-id {
            background-color: #e6f2ff;
            color: #1e5799;
            padding: 3px 10px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }
        
        .entry-time {
            color: #666;
            font-size: 0.9rem;
        }
        
        .entry-details {
            font-size: 0.95rem;
            color: #444;
        }
        
        .entry-details div {
            margin-bottom: 5px;
        }
        
        .save-indicator {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: #4caf50;
            color: white;
            padding: 10px 20px;
            border-radius: 30px;
            font-size: 0.9rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            display: none;
            z-index: 1000;
            animation: fadeInOut 2s ease;
        }
        
        @keyframes fadeInOut {
            0% { opacity: 0; transform: translateY(10px); }
            20% { opacity: 1; transform: translateY(0); }
            80% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(10px); }
        }
        
        .export-indicator {
            position: fixed;
            bottom: 80px;
            right: 20px;
            background-color: #28a745;
            color: white;
            padding: 10px 20px;
            border-radius: 30px;
            font-size: 0.9rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            display: none;
            z-index: 1000;
            animation: fadeInOut 3s ease;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #888;
        }
        
        .empty-state::before {
            content: "ğŸ“„";
            font-size: 3rem;
            margin-bottom: 15px;
            display: block;
            color: #d1e3ff;
        }
        
        .empty-state p {
            font-size: 1.1rem;
        }
        
        /* iOSä¼˜åŒ– */
        input, select, button {
            font-size: 16px; /* é˜²æ­¢iOSç¼©æ”¾ */
        }
        
        button:active {
            opacity: 0.8;
        }
        
        /* å“åº”å¼è°ƒæ•´ */
        @media (max-width: 480px) {
            .behavior-btn-container {
                grid-template-columns: repeat(2, 1fr);
                gap: 6px;
            }
            
            .behavior-btn {
                padding: 10px 4px;
                font-size: 0.8rem;
                min-height: 65px;
            }
            
            .survey-item {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .delete-btn, .export-btn {
                align-self: flex-end;
                margin-top: 10px;
                margin-left: 0;
                margin-right: 10px;
            }
            
            .survey-item > div:last-child {
                display: flex;
                align-self: flex-end;
                margin-top: 10px;
            }
            
            .section-title {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .section-title > div {
                margin-top: 10px;
                display: flex;
                flex-wrap: wrap;
            }
            
            .export-section-btn, .time-btn {
                margin-left: 0;
                margin-right: 10px;
                margin-bottom: 10px;
            }
        }
        
        @media (max-width: 360px) {
            .behavior-btn-container {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .behavior-btn {
                font-size: 0.75rem;
                padding: 8px 4px;
                min-height: 60px;
            }
        }
        
        /* è‡ªå®šä¹‰æ»šåŠ¨æ¡ */
        ::-webkit-scrollbar {
            width: 6px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
        
        .auto-id {
            background-color: #f0f8ff;
            padding: 8px 12px;
            border-radius: 6px;
            font-family: monospace;
            font-weight: bold;
            color: #1e5799;
            text-align: center;
            margin: 10px 0;
        }
        
        .export-help {
            background-color: #f8f9fa;
            border-left: 4px solid #28a745;
            padding: 12px;
            margin: 15px 0;
            border-radius: 4px;
            font-size: 0.9rem;
            color: #495057;
        }
        
        .export-help::before {
            content: "â„¹ï¸";
            margin-right: 8px;
        }
        
        .state-indicator {
            background-color: #e6f2ff;
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            font-size: 0.9rem;
            text-align: center;
        }
        
        /* æ»šåŠ¨ä¼˜åŒ– */
        .scrollable-container {
            -webkit-overflow-scrolling: touch;
            overflow-y: auto;
        }
        
        /* é˜²æ­¢è¯¯è§¦çš„æ»‘åŠ¨åŒºåŸŸ */
        .swipe-guard {
            position: relative;
        }
        
        /* ä¼˜åŒ–è§¦æ‘¸æ»šåŠ¨ */
        .touch-scroll-optimized {
            -webkit-overflow-scrolling: touch;
            overflow-y: auto;
            scroll-behavior: smooth;
        }
        
        /* é˜²æ­¢æŒ‰é’®åœ¨æ»šåŠ¨æ—¶è¢«è§¦å‘ */
        .behavior-btn-container {
            position: relative;
            z-index: 1;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>é«˜é“å¹²æ‰°ä¸‹æ°´é¸Ÿè¡Œä¸ºè§‚æµ‹è®°å½•ç³»ç»Ÿ</h1>
        <p>æ‰€æœ‰æ•°æ®ä¿®æ”¹åå®æ—¶è‡ªåŠ¨ä¿å­˜ï¼Œæ”¯æŒåˆ é™¤å’Œå¯¼å‡ºåŠŸèƒ½</p>
    </div>
    
    <div class="tab-container">
        <div class="tab active" data-tab="observation">
            è§‚æµ‹å¯¹è±¡
        </div>
        <div class="tab" data-tab="interference">
            é«˜é“å¹²æ‰°
        </div>
        <div class="tab" data-tab="behavior">
            é¸Ÿç±»è¡Œä¸º
        </div>
    </div>
    
    <!-- è§‚æµ‹å¯¹è±¡è®°å½•æ¿å— -->
    <div class="panel active" id="observation-panel">
        <div class="section-title">
            <span>è§‚æµ‹å¯¹è±¡è®°å½•</span>
            <div>
                <button class="export-section-btn" id="export-all-observation">
                    å¯¼å‡ºå…¨éƒ¨è®°å½•
                </button>
            </div>
        </div>
        
        <div class="export-help">
            å¯¼å‡ºåŠŸèƒ½è¯´æ˜ï¼šç‚¹å‡»å¯¼å‡ºæŒ‰é’®åï¼Œæ•°æ®ä¼šç”Ÿæˆå¹¶è‡ªåŠ¨ä¸‹è½½ä¸ºCSVæ–‡ä»¶ã€‚å¦‚æœæœªè‡ªåŠ¨ä¸‹è½½ï¼Œè¯·æ£€æŸ¥æµè§ˆå™¨ä¸‹è½½è®¾ç½®ã€‚
        </div>
        
        <button class="add-survey-btn" id="add-observation-survey">
            æ–°å»ºè§‚æµ‹å¯¹è±¡è°ƒç ”è®°å½•
        </button>
        
        <!-- æ–°å»ºè°ƒç ”è®°å½•è¡¨å• -->
        <div class="form-container" id="observation-form">
            <div class="form-group">
                <label>è§‚æµ‹åœ°</label>
                <select class="form-control" id="observation-site">
                    <option value="">è¯·é€‰æ‹©è§‚æµ‹åœ°</option>
                    <option value="A">A</option>
                    <option value="B">B</option>
                    <option value="C">C</option>
                </select>
            </div>
            
            <div class="form-group">
                <label>æ—¥æœŸ</label>
                <input type="date" class="form-control" id="observation-date">
            </div>
            
            <button class="add-survey-btn" id="save-observation-survey">
                åˆ›å»ºè°ƒç ”è®°å½•å¹¶å¼€å§‹åˆ†æ¡è®°å½•
            </button>
        </div>
        
        <!-- è°ƒç ”è®°å½•åˆ—è¡¨ -->
        <div class="survey-list" id="observation-survey-list">
            <!-- è°ƒç ”è®°å½•å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
        </div>
        
        <!-- åˆ†æ¡è®°å½•åŒºåŸŸ -->
        <div id="observation-entries-area" style="display: none;">
            <div class="section-title">
                <span>è§‚æµ‹å¯¹è±¡åˆ†æ¡è®°å½•</span>
                <div>
                    <button class="export-section-btn" id="export-observation-entries">
                        å¯¼å‡ºå½“å‰è®°å½•
                    </button>
                    <button class="time-btn" id="back-to-observation-list">
                        è¿”å›
                    </button>
                </div>
            </div>
            
            <div class="state-indicator" id="observation-state">
                å½“å‰è§‚æµ‹åœ°ï¼š<span id="current-observation-site"></span>ï¼Œæ—¥æœŸï¼š<span id="current-observation-date"></span>
            </div>
            
            <button class="add-survey-btn" id="add-observation-entry">
                æ–°å»ºè§‚æµ‹å¯¹è±¡è®°å½•
            </button>
            
            <!-- åˆ†æ¡è®°å½•è¡¨å• -->
            <div class="form-container" id="observation-entry-form">
                <div class="form-group">
                    <label>å¯¹è±¡ç¼–å·</label>
                    <input type="text" class="form-control" id="object-id" placeholder="è¯·è¾“å…¥å¯¹è±¡ç¼–å·">
                </div>
                
                <div class="form-group">
                    <label>å…·ä½“ç§å</label>
                    <input type="text" class="form-control" id="species" placeholder="è¯·è¾“å…¥å…·ä½“ç§å">
                </div>
                
                <div class="form-group">
                    <label>æ´»åŠ¨è§„æ¨¡</label>
                    <input type="text" class="form-control" id="activity-scale" placeholder="è¯·è¾“å…¥æ´»åŠ¨è§„æ¨¡">
                </div>
                
                <div class="form-group">
                    <label>ä½ç½®ä¸è½¨è¿¹ç¼–å·</label>
                    <input type="text" class="form-control" id="location" placeholder="è¯·è¾“å…¥ä½ç½®ä¸è½¨è¿¹ç¼–å·">
                </div>
                
                <div class="form-group">
                    <label>å¤©æ°”æƒ…å†µ</label>
                    <input type="text" class="form-control" id="weather" placeholder="è¯·è¾“å…¥å¤©æ°”æƒ…å†µ">
                </div>
                
                <div class="form-group">
                    <label>è§‚æµ‹å¼€å§‹æ—¶é—´</label>
                    <input type="datetime-local" class="form-control" id="start-time">
                </div>
                
                <div class="form-group">
                    <label>è§‚æµ‹ç»“æŸæ—¶é—´</label>
                    <input type="datetime-local" class="form-control" id="end-time">
                </div>
                
                <button class="add-survey-btn" id="save-observation-entry">
                    ä¿å­˜è§‚æµ‹å¯¹è±¡è®°å½•
                </button>
            </div>
            
            <!-- åˆ†æ¡è®°å½•åˆ—è¡¨ -->
            <div class="entry-list" id="observation-entry-list">
                <!-- åˆ†æ¡è®°å½•å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>
    </div>
    
    <!-- é«˜é“å¹²æ‰°è®°å½•æ¿å— -->
    <div class="panel" id="interference-panel">
        <div class="section-title">
            <span>é«˜é“å¹²æ‰°è®°å½•</span>
            <div>
                <button class="export-section-btn" id="export-all-interference">
                    å¯¼å‡ºå…¨éƒ¨è®°å½•
                </button>
            </div>
        </div>
        
        <div class="export-help">
            å¯¼å‡ºåŠŸèƒ½è¯´æ˜ï¼šç‚¹å‡»å¯¼å‡ºæŒ‰é’®åï¼Œæ•°æ®ä¼šç”Ÿæˆå¹¶è‡ªåŠ¨ä¸‹è½½ä¸ºCSVæ–‡ä»¶ã€‚å¦‚æœæœªè‡ªåŠ¨ä¸‹è½½ï¼Œè¯·æ£€æŸ¥æµè§ˆå™¨ä¸‹è½½è®¾ç½®ã€‚
        </div>
        
        <button class="add-survey-btn" id="add-interference-survey">
            æ–°å»ºé«˜é“å¹²æ‰°è°ƒç ”è®°å½•
        </button>
        
        <!-- æ–°å»ºè°ƒç ”è®°å½•è¡¨å• -->
        <div class="form-container" id="interference-form">
            <div class="form-group">
                <label>è§‚æµ‹åœ°</label>
                <select class="form-control" id="interference-site">
                    <option value="">è¯·é€‰æ‹©è§‚æµ‹åœ°</option>
                    <option value="A">A</option>
                    <option value="B">B</option>
                    <option value="C">C</option>
                </select>
            </div>
            
            <div class="form-group">
                <label>æ—¥æœŸ</label>
                <input type="date" class="form-control" id="interference-date">
            </div>
            
            <button class="add-survey-btn" id="save-interference-survey">
                åˆ›å»ºè°ƒç ”è®°å½•å¹¶å¼€å§‹åˆ†æ¡è®°å½•
            </button>
        </div>
        
        <!-- è°ƒç ”è®°å½•åˆ—è¡¨ -->
        <div class="survey-list" id="interference-survey-list">
            <!-- è°ƒç ”è®°å½•å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
        </div>
        
        <!-- åˆ†æ¡è®°å½•åŒºåŸŸ -->
        <div id="interference-entries-area" style="display: none;">
            <div class="section-title">
                <span>é«˜é“å¹²æ‰°åˆ†æ¡è®°å½•</span>
                <div>
                    <button class="export-section-btn" id="export-interference-entries">
                        å¯¼å‡ºå½“å‰è®°å½•
                    </button>
                    <button class="time-btn" id="back-to-interference-list">
                        è¿”å›
                    </button>
                </div>
            </div>
            
            <div class="state-indicator" id="interference-state">
                å½“å‰è§‚æµ‹åœ°ï¼š<span id="current-interference-site"></span>ï¼Œæ—¥æœŸï¼š<span id="current-interference-date"></span>
            </div>
            
            <button class="add-survey-btn" id="add-interference-entry">
                æ–°å»ºé«˜é“å¹²æ‰°è®°å½•
            </button>
            
            <!-- åˆ†æ¡è®°å½•è¡¨å• -->
            <div class="form-container" id="interference-entry-form">
                <div class="form-group">
                    <label>é«˜é“å¹²æ‰°äº‹ä»¶ç¼–å·</label>
                    <div class="auto-id" id="auto-interference-id">ç­‰å¾…ç”Ÿæˆ...</div>
                    <input type="hidden" id="interference-id">
                </div>
                
                <div class="form-group">
                    <label>è½¦å¢èŠ‚æ•°</label>
                    <input type="number" class="form-control" id="carriage-count" placeholder="è¯·è¾“å…¥è½¦å¢èŠ‚æ•°" min="1">
                </div>
                
                <div class="form-group">
                    <label>ç»è¿‡æ—¶é—´</label>
                    <div>
                        <input type="text" class="form-control" id="passing-time" placeholder="ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®è·å–æ—¶é—´" readonly>
                        <button class="time-btn" id="record-time-btn" style="margin-top: 10px; width: 100%;">
                            å¼€å§‹è®°å½•æ—¶é—´
                        </button>
                    </div>
                </div>
                
                <button class="add-survey-btn" id="save-interference-entry">
                    ä¿å­˜é«˜é“å¹²æ‰°è®°å½•
                </button>
            </div>
            
            <!-- åˆ†æ¡è®°å½•åˆ—è¡¨ -->
            <div class="entry-list" id="interference-entry-list">
                <!-- åˆ†æ¡è®°å½•å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>
    </div>
    
    <!-- é¸Ÿç±»è¡Œä¸ºè®°å½•æ¿å— -->
    <div class="panel" id="behavior-panel">
        <div class="section-title">
            <span>é¸Ÿç±»è¡Œä¸ºè®°å½•</span>
            <div>
                <button class="export-section-btn" id="export-all-behavior">
                    å¯¼å‡ºå…¨éƒ¨è®°å½•
                </button>
            </div>
        </div>
        
        <div class="export-help">
            å¯¼å‡ºåŠŸèƒ½è¯´æ˜ï¼šç‚¹å‡»å¯¼å‡ºæŒ‰é’®åï¼Œæ•°æ®ä¼šç”Ÿæˆå¹¶è‡ªåŠ¨ä¸‹è½½ä¸ºCSVæ–‡ä»¶ã€‚å¦‚æœæœªè‡ªåŠ¨ä¸‹è½½ï¼Œè¯·æ£€æŸ¥æµè§ˆå™¨ä¸‹è½½è®¾ç½®ã€‚
        </div>
        
        <button class="add-survey-btn" id="add-behavior-survey">
            æ–°å»ºé¸Ÿç±»è¡Œä¸ºè°ƒç ”è®°å½•
        </button>
        
        <!-- æ–°å»ºè°ƒç ”è®°å½•è¡¨å• - æ–°å¢è§‚æµ‹å¯¹è±¡ç¼–å· -->
        <div class="form-container" id="behavior-form">
            <div class="form-group">
                <label>è§‚æµ‹åœ°</label>
                <select class="form-control" id="behavior-site">
                    <option value="">è¯·é€‰æ‹©è§‚æµ‹åœ°</option>
                    <option value="A">A</option>
                    <option value="B">B</option>
                    <option value="C">C</option>
                </select>
            </div>
            
            <div class="form-group">
                <label>æ—¥æœŸ</label>
                <input type="date" class="form-control" id="behavior-date">
            </div>
            
            <div class="form-group">
                <label>è§‚æµ‹å¯¹è±¡ç¼–å·</label>
                <input type="text" class="form-control" id="behavior-object-id" placeholder="è¯·è¾“å…¥è§‚æµ‹å¯¹è±¡ç¼–å·ï¼ˆå¯é€‰ï¼‰">
            </div>
            
            <button class="add-survey-btn" id="save-behavior-survey">
                åˆ›å»ºè°ƒç ”è®°å½•å¹¶å¼€å§‹è®°å½•è¡Œä¸º
            </button>
        </div>
        
        <!-- è°ƒç ”è®°å½•åˆ—è¡¨ -->
        <div class="survey-list" id="behavior-survey-list">
            <!-- è°ƒç ”è®°å½•å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
        </div>
        
        <!-- è¡Œä¸ºè®°å½•åŒºåŸŸ -->
        <div id="behavior-entries-area" style="display: none;">
            <div class="section-title">
                <span>é¸Ÿç±»è¡Œä¸ºè®°å½•</span>
                <div>
                    <button class="export-section-btn" id="export-behavior-entries">
                        å¯¼å‡ºå½“å‰è®°å½•
                    </button>
                    <button class="time-btn" id="back-to-behavior-list">
                        è¿”å›
                    </button>
                </div>
            </div>
            
            <div class="state-indicator" id="behavior-state">
                å½“å‰è§‚æµ‹åœ°ï¼š<span id="current-behavior-site"></span>ï¼Œæ—¥æœŸï¼š<span id="current-behavior-date"></span>ï¼Œè§‚æµ‹å¯¹è±¡ï¼š<span id="current-behavior-object"></span>
            </div>
            
            <div class="behavior-btn-container">
                <!-- è¡Œä¸ºæŒ‰é’® - æ–°å¢å’Œä¿®æ”¹ -->
                <button class="behavior-btn" data-behavior="è§…é£Ÿ">
                    è§…é£Ÿ
                </button>
                <button class="behavior-btn" data-behavior="è¿›é£Ÿ">
                    è¿›é£Ÿ
                </button>
                <button class="behavior-btn" data-behavior="è§…é£ŸæˆåŠŸ">
                    è§…é£ŸæˆåŠŸ
                </button>
                <button class="behavior-btn" data-behavior="é¥®æ°´">
                    é¥®æ°´
                </button>
                <button class="behavior-btn" data-behavior="èµ·é£">
                    èµ·é£
                </button>
                <button class="behavior-btn" data-behavior="æƒŠé£">
                    æƒŠé£
                </button>
                <button class="behavior-btn" data-behavior="é™è½">
                    é™è½
                </button>
                <button class="behavior-btn" data-behavior="ç†ç¾½">
                    ç†ç¾½
                </button>
                <button class="behavior-btn" data-behavior="äº¤æµé¸£å«">
                    äº¤æµé¸£å«
                </button>
                <button class="behavior-btn" data-behavior="äº’åŠ¨è¡Œä¸ºï¼ˆç§¯æï¼‰">
                    äº’åŠ¨ï¼ˆç§¯æï¼‰
                </button>
                <button class="behavior-btn" data-behavior="äº’åŠ¨è¡Œä¸ºï¼ˆæ¶ˆæï¼‰">
                    äº’åŠ¨ï¼ˆæ¶ˆæï¼‰
                </button>
                <button class="behavior-btn" data-behavior="è­¦ç¤ºé¸£å«">
                    è­¦ç¤ºé¸£å«
                </button>
                <button class="behavior-btn" data-behavior="å¼ æœ›ï¼ˆ3sï¼‰">
                    å¼ æœ›ï¼ˆ3sï¼‰
                </button>
                <button class="behavior-btn" data-behavior="è­¦æˆ’">
                    è­¦æˆ’
                </button>
                <button class="behavior-btn" data-behavior="åŠ é€Ÿç§»åŠ¨">
                    åŠ é€Ÿç§»åŠ¨
                </button>
                
                <!-- åˆ†å¸ƒæŒ‰é’® - æ–°å¢å½’å²¸ã€ç¦»å²¸ -->
                <button class="behavior-btn distribution" data-behavior="é›†ç¾¤">
                    é›†ç¾¤
                </button>
                <button class="behavior-btn distribution" data-behavior="åˆ†æ•£">
                    åˆ†æ•£
                </button>
                <button class="behavior-btn distribution" data-behavior="å½’å²¸">
                    å½’å²¸
                </button>
                <button class="behavior-btn distribution" data-behavior="ç¦»å²¸">
                    ç¦»å²¸
                </button>
                <button class="behavior-btn distribution" data-behavior="ä½ç½®å˜æ›´0-30">
                    å˜æ›´0-30
                </button>
                <button class="behavior-btn distribution" data-behavior="ä½ç½®å˜æ›´30-60">
                    å˜æ›´30-60
                </button>
                <button class="behavior-btn distribution" data-behavior="ä½ç½®å˜æ›´60-100">
                    å˜æ›´60-100
                </button>
                <button class="behavior-btn distribution" data-behavior="ä½ç½®å˜æ›´100-150">
                    å˜æ›´100-150
                </button>
                <button class="behavior-btn distribution" data-behavior="ä½ç½®å˜æ›´150-250">
                    å˜æ›´150-250
                </button>
            </div>
            
            <!-- è¡Œä¸ºè®°å½•åˆ—è¡¨ -->
            <div class="entry-list" id="behavior-entry-list">
                <!-- è¡Œä¸ºè®°å½•å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>
    </div>
    
    <div class="save-indicator" id="save-indicator">
        æ•°æ®å·²ä¿å­˜
    </div>
    
    <div class="export-indicator" id="export-indicator">
        æ–‡ä»¶å·²ç”Ÿæˆï¼Œæ­£åœ¨ä¸‹è½½...
    </div>

    <script>
        // å…¨å±€å˜é‡ - ä½¿ç”¨å¯¹è±¡å­˜å‚¨ä¸åŒé¢æ¿çš„çŠ¶æ€
        let appState = {
            currentPanel: 'observation',
            currentSurvey: {
                observation: null,
                interference: null,
                behavior: null
            },
            panelData: {
                observation: null,
                interference: null,
                behavior: null
            }
        };
        
        // åˆå§‹åŒ–æ—¥æœŸå­—æ®µä¸ºä»Šå¤©
        document.addEventListener('DOMContentLoaded', function() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('observation-date').value = today;
            document.getElementById('interference-date').value = today;
            document.getElementById('behavior-date').value = today;
            
            // ä»localStorageåŠ è½½æ•°æ®
            loadAllData();
            
            // åˆå§‹åŒ–é€‰é¡¹å¡
            initTabs();
            
            // åˆå§‹åŒ–äº‹ä»¶ç›‘å¬å™¨
            initEventListeners();
            
            // æ·»åŠ iOSç‰¹å®šä¼˜åŒ–
            optimizeForIOS();
        });
        
        // iOSä¼˜åŒ–å‡½æ•°
        function optimizeForIOS() {
            // é˜²æ­¢åŒå‡»ç¼©æ”¾
            let lastTouchEnd = 0;
            document.addEventListener('touchend', function(event) {
                const now = (new Date()).getTime();
                if (now - lastTouchEnd <= 300) {
                    event.preventDefault();
                }
                lastTouchEnd = now;
            }, false);
            
            // é˜²æ­¢æ»šåŠ¨æ—¶è§¦å‘ç‚¹å‡»
            let isScrolling;
            let scrollStartY = 0;
            
            document.addEventListener('touchstart', function(e) {
                isScrolling = false;
                scrollStartY = e.touches[0].pageY;
            });
            
            document.addEventListener('touchmove', function(e) {
                const currentY = e.touches[0].pageY;
                const deltaY = Math.abs(currentY - scrollStartY);
                
                // å¦‚æœå‚ç›´æ»šåŠ¨è¶…è¿‡10pxï¼Œè®¤ä¸ºæ˜¯æ»šåŠ¨è€Œä¸æ˜¯ç‚¹å‡»
                if (deltaY > 10) {
                    isScrolling = true;
                }
            });
            
            document.addEventListener('touchend', function(e) {
                if (isScrolling) {
                    e.preventDefault();
                    return false;
                }
            });
            
            // ä¼˜åŒ–æ»šåŠ¨æ€§èƒ½
            document.querySelectorAll('.panel, .entry-list, .survey-list').forEach(el => {
                el.style.webkitOverflowScrolling = 'touch';
            });
        }
        
        // åˆå§‹åŒ–é€‰é¡¹å¡
        function initTabs() {
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => {
                // ä½¿ç”¨touchstartå’Œclickäº‹ä»¶ç¡®ä¿iOSå“åº”
                tab.addEventListener('touchstart', function(e) {
                    e.preventDefault();
                    const tabId = this.getAttribute('data-tab');
                    switchPanel(tabId);
                });
                
                tab.addEventListener('click', function() {
                    const tabId = this.getAttribute('data-tab');
                    switchPanel(tabId);
                });
            });
        }
        
        // åˆ‡æ¢é¢æ¿å‡½æ•°
        function switchPanel(tabId) {
            // æ›´æ–°é€‰é¡¹å¡æ ·å¼
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelector(`.tab[data-tab="${tabId}"]`).classList.add('active');
            
            // æ˜¾ç¤ºå¯¹åº”é¢æ¿
            document.querySelectorAll('.panel').forEach(panel => {
                panel.classList.remove('active');
            });
            document.getElementById(`${tabId}-panel`).classList.add('active');
            
            appState.currentPanel = tabId;
            
            // ç¡®ä¿è¡Œä¸ºæŒ‰é’®æ­£å¸¸å·¥ä½œ
            if (tabId === 'behavior') {
                setTimeout(() => {
                    rebindBehaviorButtons();
                }, 100);
            }
        }
        
        // é‡æ–°ç»‘å®šè¡Œä¸ºæŒ‰é’®ï¼ˆé˜²æ­¢iOSä¸Šçš„ç‚¹å‡»é—®é¢˜ï¼‰
        function rebindBehaviorButtons() {
            const behaviorButtons = document.querySelectorAll('.behavior-btn');
            behaviorButtons.forEach(btn => {
                // ç§»é™¤ç°æœ‰çš„äº‹ä»¶ç›‘å¬å™¨
                const newBtn = btn.cloneNode(true);
                btn.parentNode.replaceChild(newBtn, btn);
                
                // é‡æ–°ç»‘å®šäº‹ä»¶
                newBtn.addEventListener('touchstart', function(e) {
                    e.preventDefault();
                    const behavior = this.getAttribute('data-behavior');
                    recordBehavior(behavior);
                });
                
                newBtn.addEventListener('click', function() {
                    const behavior = this.getAttribute('data-behavior');
                    recordBehavior(behavior);
                });
            });
        }
        
        // åˆå§‹åŒ–æ‰€æœ‰äº‹ä»¶ç›‘å¬å™¨
        function initEventListeners() {
            // è§‚æµ‹å¯¹è±¡æ¿å—
            document.getElementById('add-observation-survey').addEventListener('click', function() {
                document.getElementById('observation-form').classList.add('active');
            });
            
            document.getElementById('save-observation-survey').addEventListener('click', saveObservationSurvey);
            
            document.getElementById('add-observation-entry').addEventListener('click', function() {
                document.getElementById('observation-entry-form').classList.add('active');
            });
            
            document.getElementById('save-observation-entry').addEventListener('click', saveObservationEntry);
            
            document.getElementById('back-to-observation-list').addEventListener('click', function() {
                document.getElementById('observation-entries-area').style.display = 'none';
                document.getElementById('observation-panel').querySelector('.survey-list').style.display = 'block';
                document.getElementById('add-observation-survey').style.display = 'block';
                appState.currentSurvey.observation = null;
                // ä¿®å¤ï¼šè¿”å›åé‡æ–°åŠ è½½åˆ—è¡¨ä»¥æ›´æ–°è®°å½•æ¡æ•°
                loadObservationSurveys();
            });
            
            // é«˜é“å¹²æ‰°æ¿å—
            document.getElementById('add-interference-survey').addEventListener('click', function() {
                document.getElementById('interference-form').classList.add('active');
            });
            
            document.getElementById('save-interference-survey').addEventListener('click', saveInterferenceSurvey);
            
            document.getElementById('add-interference-entry').addEventListener('click', function() {
                // ç”Ÿæˆè‡ªåŠ¨ç¼–å·
                generateInterferenceId();
                document.getElementById('interference-entry-form').classList.add('active');
            });
            
            document.getElementById('save-interference-entry').addEventListener('click', saveInterferenceEntry);
            
            document.getElementById('record-time-btn').addEventListener('click', function() {
                const now = new Date();
                const timeString = now.toLocaleTimeString('zh-CN', { hour12: false });
                document.getElementById('passing-time').value = timeString;
                showSaveIndicator();
            });
            
            document.getElementById('back-to-interference-list').addEventListener('click', function() {
                document.getElementById('interference-entries-area').style.display = 'none';
                document.getElementById('interference-panel').querySelector('.survey-list').style.display = 'block';
                document.getElementById('add-interference-survey').style.display = 'block';
                appState.currentSurvey.interference = null;
                // ä¿®å¤ï¼šè¿”å›åé‡æ–°åŠ è½½åˆ—è¡¨ä»¥æ›´æ–°è®°å½•æ¡æ•°
                loadInterferenceSurveys();
            });
            
            // é¸Ÿç±»è¡Œä¸ºæ¿å—
            document.getElementById('add-behavior-survey').addEventListener('click', function() {
                document.getElementById('behavior-form').classList.add('active');
            });
            
            document.getElementById('save-behavior-survey').addEventListener('click', saveBehaviorSurvey);
            
            document.getElementById('back-to-behavior-list').addEventListener('click', function() {
                document.getElementById('behavior-entries-area').style.display = 'none';
                document.getElementById('behavior-panel').querySelector('.survey-list').style.display = 'block';
                document.getElementById('add-behavior-survey').style.display = 'block';
                appState.currentSurvey.behavior = null;
                // ä¿®å¤ï¼šè¿”å›åé‡æ–°åŠ è½½åˆ—è¡¨ä»¥æ›´æ–°è®°å½•æ¡æ•°
                loadBehaviorSurveys();
            });
            
            // è¡Œä¸ºæŒ‰é’® - ä½¿ç”¨æ›´å¯é çš„äº‹ä»¶ç»‘å®š
            rebindBehaviorButtons();
            
            // å¯¼å‡ºæŒ‰é’®äº‹ä»¶
            document.getElementById('export-all-observation').addEventListener('click', function() {
                exportAllObservation();
            });
            document.getElementById('export-observation-entries').addEventListener('click', function() {
                exportObservationEntries();
            });
            document.getElementById('export-all-interference').addEventListener('click', function() {
                exportAllInterference();
            });
            document.getElementById('export-interference-entries').addEventListener('click', function() {
                exportInterferenceEntries();
            });
            document.getElementById('export-all-behavior').addEventListener('click', function() {
                exportAllBehavior();
            });
            document.getElementById('export-behavior-entries').addEventListener('click', function() {
                exportBehaviorEntries();
            });
            
            // å®æ—¶ä¿å­˜åŠŸèƒ½
            document.querySelectorAll('input, select').forEach(element => {
                element.addEventListener('change', function() {
                    showSaveIndicator();
                });
            });
        }
        
        // ç”Ÿæˆé«˜é“å¹²æ‰°äº‹ä»¶è‡ªåŠ¨ç¼–å·
        function generateInterferenceId() {
            if (!appState.currentSurvey.interference) return;
            
            // è·å–å½“å‰è°ƒç ”è®°å½•ä¿¡æ¯
            let surveys = JSON.parse(localStorage.getItem('interferenceSurveys') || '[]');
            const surveyIndex = surveys.findIndex(s => s.id === appState.currentSurvey.interference);
            
            if (surveyIndex === -1) return;
            
            const survey = surveys[surveyIndex];
            const site = survey.site;
            
            // è·å–å½“å‰è®°å½•æ•°ï¼Œç¡®å®šä¸‹ä¸€ä¸ªç¼–å·
            const existingEntries = survey.entries || [];
            const nextNumber = existingEntries.length + 1;
            const idNumber = nextNumber.toString().padStart(4, '0');
            const entryId = `G${site}${idNumber}`;
            
            // æ˜¾ç¤ºåœ¨è¡¨å•ä¸­
            document.getElementById('auto-interference-id').textContent = entryId;
            document.getElementById('interference-id').value = entryId;
        }
        
        // é‡æ–°æ’åºé«˜é“å¹²æ‰°äº‹ä»¶ç¼–å·
        function reorderInterferenceIds(surveyId) {
            let surveys = JSON.parse(localStorage.getItem('interferenceSurveys') || '[]');
            const surveyIndex = surveys.findIndex(s => s.id === surveyId);
            
            if (surveyIndex === -1) return;
            
            const survey = surveys[surveyIndex];
            const site = survey.site;
            
            if (!survey.entries || survey.entries.length === 0) return;
            
            // æŒ‰æ—¶é—´æˆ³æ’åºï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰æˆ–ä¿æŒåŸé¡ºåº
            let sortedEntries = [...survey.entries];
            // å¦‚æœæœ‰timestampå­—æ®µï¼ŒæŒ‰æ—¶é—´æ’åº
            if (sortedEntries[0].timestamp) {
                sortedEntries.sort((a, b) => a.timestamp - b.timestamp);
            }
            
            // é‡æ–°ç¼–å·
            sortedEntries.forEach((entry, index) => {
                const newNumber = (index + 1).toString().padStart(4, '0');
                entry.interferenceId = `G${site}${newNumber}`;
            });
            
            // ä¿å­˜å›localStorage
            surveys[surveyIndex].entries = sortedEntries;
            localStorage.setItem('interferenceSurveys', JSON.stringify(surveys));
        }
        
        // é‡æ–°æ’åºé¸Ÿç±»è¡Œä¸ºç¼–å·
        function reorderBehaviorIds(surveyId) {
            let surveys = JSON.parse(localStorage.getItem('behaviorSurveys') || '[]');
            const surveyIndex = surveys.findIndex(s => s.id === surveyId);
            
            if (surveyIndex === -1) return;
            
            const survey = surveys[surveyIndex];
            const site = survey.site;
            
            if (!survey.entries || survey.entries.length === 0) return;
            
            // æŒ‰æ—¶é—´æˆ³æ’åº
            let sortedEntries = [...survey.entries];
            sortedEntries.sort((a, b) => a.timestamp - b.timestamp);
            
            // é‡æ–°ç¼–å·
            sortedEntries.forEach((entry, index) => {
                const newNumber = (index + 1).toString().padStart(4, '0');
                entry.id = `${site}${newNumber}`;
            });
            
            // ä¿å­˜å›localStorage
            surveys[surveyIndex].entries = sortedEntries;
            localStorage.setItem('behaviorSurveys', JSON.stringify(surveys));
        }
        
        // ä¿å­˜è§‚æµ‹å¯¹è±¡è°ƒç ”è®°å½•
        function saveObservationSurvey() {
            const site = document.getElementById('observation-site').value;
            const date = document.getElementById('observation-date').value;
            
            if (!site) {
                alert('è¯·é€‰æ‹©è§‚æµ‹åœ°');
                return;
            }
            
            const surveyId = 'obs_' + Date.now();
            const survey = {
                id: surveyId,
                type: 'observation',
                site: site,
                date: date,
                entries: []
            };
            
            // ä¿å­˜åˆ°localStorage
            let surveys = JSON.parse(localStorage.getItem('observationSurveys') || '[]');
            surveys.push(survey);
            localStorage.setItem('observationSurveys', JSON.stringify(surveys));
            
            // éšè—è¡¨å•
            document.getElementById('observation-form').classList.remove('active');
            
            // æ¸…ç©ºè¡¨å•
            document.getElementById('observation-site').value = '';
            
            // æ˜¾ç¤ºä¿å­˜æç¤º
            showSaveIndicator();
            
            // é‡æ–°åŠ è½½åˆ—è¡¨
            loadObservationSurveys();
            
            // è¿›å…¥åˆ†æ¡è®°å½•ç•Œé¢
            enterObservationEntries(surveyId);
        }
        
        // è¿›å…¥è§‚æµ‹å¯¹è±¡åˆ†æ¡è®°å½•ç•Œé¢
        function enterObservationEntries(surveyId) {
            // éšè—è°ƒç ”è®°å½•åˆ—è¡¨
            document.getElementById('observation-survey-list').style.display = 'none';
            document.getElementById('add-observation-survey').style.display = 'none';
            
            // æ˜¾ç¤ºåˆ†æ¡è®°å½•åŒºåŸŸ
            document.getElementById('observation-entries-area').style.display = 'block';
            
            // è®¾ç½®å½“å‰è°ƒç ”è®°å½•
            appState.currentSurvey.observation = surveyId;
            
            // åŠ è½½åˆ†æ¡è®°å½•
            loadObservationEntries(surveyId);
            
            // æ˜¾ç¤ºå½“å‰çŠ¶æ€
            let surveys = JSON.parse(localStorage.getItem('observationSurveys') || '[]');
            const survey = surveys.find(s => s.id === surveyId);
            if (survey) {
                document.getElementById('current-observation-site').textContent = survey.site;
                document.getElementById('current-observation-date').textContent = survey.date;
            }
        }
        
        // ä¿å­˜è§‚æµ‹å¯¹è±¡åˆ†æ¡è®°å½•
        function saveObservationEntry() {
            if (!appState.currentSurvey.observation) return;
            
            const entry = {
                id: 'entry_' + Date.now(),
                objectId: document.getElementById('object-id').value,
                species: document.getElementById('species').value,
                activityScale: document.getElementById('activity-scale').value,
                location: document.getElementById('location').value,
                weather: document.getElementById('weather').value,
                startTime: document.getElementById('start-time').value,
                endTime: document.getElementById('end-time').value
            };
            
            // éªŒè¯å¿…å¡«å­—æ®µ
            if (!entry.objectId || !entry.species) {
                alert('å¯¹è±¡ç¼–å·å’Œå…·ä½“ç§åæ˜¯å¿…å¡«é¡¹');
                return;
            }
            
            // ä¿å­˜åˆ°localStorage
            let surveys = JSON.parse(localStorage.getItem('observationSurveys') || '[]');
            const surveyIndex = surveys.findIndex(s => s.id === appState.currentSurvey.observation);
            
            if (surveyIndex !== -1) {
                if (!surveys[surveyIndex].entries) {
                    surveys[surveyIndex].entries = [];
                }
                surveys[surveyIndex].entries.push(entry);
                localStorage.setItem('observationSurveys', JSON.stringify(surveys));
                
                // æ¸…ç©ºè¡¨å•
                document.getElementById('object-id').value = '';
                document.getElementById('species').value = '';
                document.getElementById('activity-scale').value = '';
                document.getElementById('location').value = '';
                document.getElementById('weather').value = '';
                document.getElementById('start-time').value = '';
                document.getElementById('end-time').value = '';
                
                // éšè—è¡¨å•
                document.getElementById('observation-entry-form').classList.remove('active');
                
                // æ˜¾ç¤ºä¿å­˜æç¤º
                showSaveIndicator();
                
                // é‡æ–°åŠ è½½åˆ†æ¡è®°å½•
                loadObservationEntries(appState.currentSurvey.observation);
            }
        }
        
        // ä¿å­˜é«˜é“å¹²æ‰°è°ƒç ”è®°å½•
        function saveInterferenceSurvey() {
            const site = document.getElementById('interference-site').value;
            const date = document.getElementById('interference-date').value;
            
            if (!site) {
                alert('è¯·é€‰æ‹©è§‚æµ‹åœ°');
                return;
            }
            
            const surveyId = 'int_' + Date.now();
            const survey = {
                id: surveyId,
                type: 'interference',
                site: site,
                date: date,
                entries: []
            };
            
            // ä¿å­˜åˆ°localStorage
            let surveys = JSON.parse(localStorage.getItem('interferenceSurveys') || '[]');
            surveys.push(survey);
            localStorage.setItem('interferenceSurveys', JSON.stringify(surveys));
            
            // éšè—è¡¨å•
            document.getElementById('interference-form').classList.remove('active');
            
            // æ¸…ç©ºè¡¨å•
            document.getElementById('interference-site').value = '';
            
            // æ˜¾ç¤ºä¿å­˜æç¤º
            showSaveIndicator();
            
            // é‡æ–°åŠ è½½åˆ—è¡¨
            loadInterferenceSurveys();
            
            // è¿›å…¥åˆ†æ¡è®°å½•ç•Œé¢
            enterInterferenceEntries(surveyId);
        }
        
        // è¿›å…¥é«˜é“å¹²æ‰°åˆ†æ¡è®°å½•ç•Œé¢
        function enterInterferenceEntries(surveyId) {
            // éšè—è°ƒç ”è®°å½•åˆ—è¡¨
            document.getElementById('interference-survey-list').style.display = 'none';
            document.getElementById('add-interference-survey').style.display = 'none';
            
            // æ˜¾ç¤ºåˆ†æ¡è®°å½•åŒºåŸŸ
            document.getElementById('interference-entries-area').style.display = 'block';
            
            // è®¾ç½®å½“å‰è°ƒç ”è®°å½•
            appState.currentSurvey.interference = surveyId;
            
            // åŠ è½½åˆ†æ¡è®°å½•
            loadInterferenceEntries(surveyId);
            
            // æ˜¾ç¤ºå½“å‰çŠ¶æ€
            let surveys = JSON.parse(localStorage.getItem('interferenceSurveys') || '[]');
            const survey = surveys.find(s => s.id === surveyId);
            if (survey) {
                document.getElementById('current-interference-site').textContent = survey.site;
                document.getElementById('current-interference-date').textContent = survey.date;
            }
        }
        
        // ä¿å­˜é«˜é“å¹²æ‰°åˆ†æ¡è®°å½•
        function saveInterferenceEntry() {
            if (!appState.currentSurvey.interference) return;
            
            const interferenceId = document.getElementById('interference-id').value;
            const entry = {
                id: 'entry_' + Date.now(),
                interferenceId: interferenceId,
                carriageCount: document.getElementById('carriage-count').value,
                passingTime: document.getElementById('passing-time').value,
                timestamp: Date.now()
            };
            
            // éªŒè¯å¿…å¡«å­—æ®µ
            if (!entry.passingTime) {
                alert('ç»è¿‡æ—¶é—´æ˜¯å¿…å¡«é¡¹');
                return;
            }
            
            // ä¿å­˜åˆ°localStorage
            let surveys = JSON.parse(localStorage.getItem('interferenceSurveys') || '[]');
            const surveyIndex = surveys.findIndex(s => s.id === appState.currentSurvey.interference);
            
            if (surveyIndex !== -1) {
                if (!surveys[surveyIndex].entries) {
                    surveys[surveyIndex].entries = [];
                }
                surveys[surveyIndex].entries.push(entry);
                localStorage.setItem('interferenceSurveys', JSON.stringify(surveys));
                
                // æ¸…ç©ºè¡¨å•
                document.getElementById('carriage-count').value = '';
                document.getElementById('passing-time').value = '';
                document.getElementById('auto-interference-id').textContent = 'ç­‰å¾…ç”Ÿæˆ...';
                document.getElementById('interference-id').value = '';
                
                // éšè—è¡¨å•
                document.getElementById('interference-entry-form').classList.remove('active');
                
                // æ˜¾ç¤ºä¿å­˜æç¤º
                showSaveIndicator();
                
                // é‡æ–°åŠ è½½åˆ†æ¡è®°å½•
                loadInterferenceEntries(appState.currentSurvey.interference);
            }
        }
        
        // ä¿å­˜é¸Ÿç±»è¡Œä¸ºè°ƒç ”è®°å½• - æ–°å¢è§‚æµ‹å¯¹è±¡ç¼–å·
        function saveBehaviorSurvey() {
            const site = document.getElementById('behavior-site').value;
            const date = document.getElementById('behavior-date').value;
            const objectId = document.getElementById('behavior-object-id').value;
            
            if (!site) {
                alert('è¯·é€‰æ‹©è§‚æµ‹åœ°');
                return;
            }
            
            const surveyId = 'beh_' + Date.now();
            const survey = {
                id: surveyId,
                type: 'behavior',
                site: site,
                date: date,
                objectId: objectId || 'æœªå¡«å†™', // æ–°å¢è§‚æµ‹å¯¹è±¡ç¼–å·å­—æ®µ
                entries: []
            };
            
            // ä¿å­˜åˆ°localStorage
            let surveys = JSON.parse(localStorage.getItem('behaviorSurveys') || '[]');
            surveys.push(survey);
            localStorage.setItem('behaviorSurveys', JSON.stringify(surveys));
            
            // éšè—è¡¨å•
            document.getElementById('behavior-form').classList.remove('active');
            
            // æ¸…ç©ºè¡¨å•
            document.getElementById('behavior-site').value = '';
            document.getElementById('behavior-object-id').value = '';
            
            // æ˜¾ç¤ºä¿å­˜æç¤º
            showSaveIndicator();
            
            // é‡æ–°åŠ è½½åˆ—è¡¨
            loadBehaviorSurveys();
            
            // è¿›å…¥è¡Œä¸ºè®°å½•ç•Œé¢
            enterBehaviorEntries(surveyId);
        }
        
        // è¿›å…¥é¸Ÿç±»è¡Œä¸ºè®°å½•ç•Œé¢
        function enterBehaviorEntries(surveyId) {
            // éšè—è°ƒç ”è®°å½•åˆ—è¡¨
            document.getElementById('behavior-survey-list').style.display = 'none';
            document.getElementById('add-behavior-survey').style.display = 'none';
            
            // æ˜¾ç¤ºè¡Œä¸ºè®°å½•åŒºåŸŸ
            document.getElementById('behavior-entries-area').style.display = 'block';
            
            // è®¾ç½®å½“å‰è°ƒç ”è®°å½•
            appState.currentSurvey.behavior = surveyId;
            
            // é‡æ–°ç»‘å®šè¡Œä¸ºæŒ‰é’®ï¼ˆç¡®ä¿ç‚¹å‡»æœ‰æ•ˆï¼‰
            setTimeout(() => {
                rebindBehaviorButtons();
            }, 50);
            
            // åŠ è½½è¡Œä¸ºè®°å½•
            loadBehaviorEntries(surveyId);
            
            // æ˜¾ç¤ºå½“å‰çŠ¶æ€
            let surveys = JSON.parse(localStorage.getItem('behaviorSurveys') || '[]');
            const survey = surveys.find(s => s.id === surveyId);
            if (survey) {
                document.getElementById('current-behavior-site').textContent = survey.site;
                document.getElementById('current-behavior-date').textContent = survey.date;
                document.getElementById('current-behavior-object').textContent = survey.objectId || 'æœªå¡«å†™';
            }
        }
        
        // è®°å½•é¸Ÿç±»è¡Œä¸º
        function recordBehavior(behavior) {
            if (!appState.currentSurvey.behavior) {
                alert('è¯·å…ˆåˆ›å»ºæˆ–é€‰æ‹©ä¸€ä¸ªè¡Œä¸ºè°ƒç ”è®°å½•');
                return;
            }
            
            // è·å–å½“å‰è°ƒç ”è®°å½•ä¿¡æ¯
            let surveys = JSON.parse(localStorage.getItem('behaviorSurveys') || '[]');
            const surveyIndex = surveys.findIndex(s => s.id === appState.currentSurvey.behavior);
            
            if (surveyIndex === -1) return;
            
            const survey = surveys[surveyIndex];
            const site = survey.site;
            
            // è·å–å½“å‰è®°å½•æ•°ï¼Œç¡®å®šä¸‹ä¸€ä¸ªç¼–å·
            const existingEntries = survey.entries || [];
            const nextNumber = existingEntries.length + 1;
            const idNumber = nextNumber.toString().padStart(4, '0');
            const entryId = `${site}${idNumber}`;
            
            // è·å–å½“å‰æ—¶é—´
            const now = new Date();
            const timeString = now.toLocaleTimeString('zh-CN', { hour12: false });
            
            const entry = {
                id: entryId,
                behavior: behavior,
                time: timeString,
                timestamp: now.getTime()
            };
            
            // ä¿å­˜åˆ°localStorage
            if (!surveys[surveyIndex].entries) {
                surveys[surveyIndex].entries = [];
            }
            surveys[surveyIndex].entries.push(entry);
            localStorage.setItem('behaviorSurveys', JSON.stringify(surveys));
            
            // æ˜¾ç¤ºä¿å­˜æç¤º
            showSaveIndicator();
            
            // é‡æ–°åŠ è½½è¡Œä¸ºè®°å½•
            loadBehaviorEntries(appState.currentSurvey.behavior);
        }
        
        // åˆ é™¤è°ƒç ”è®°å½•
        function deleteSurvey(type, id) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡è°ƒç ”è®°å½•å—ï¼Ÿè¿™å°†åˆ é™¤æ‰€æœ‰ç›¸å…³çš„åˆ†æ¡è®°å½•ã€‚')) {
                return;
            }
            
            let key;
            if (type === 'observation') key = 'observationSurveys';
            else if (type === 'interference') key = 'interferenceSurveys';
            else if (type === 'behavior') key = 'behaviorSurveys';
            else return;
            
            let surveys = JSON.parse(localStorage.getItem(key) || '[]');
            surveys = surveys.filter(s => s.id !== id);
            localStorage.setItem(key, JSON.stringify(surveys));
            
            showSaveIndicator();
            
            // é‡æ–°åŠ è½½å¯¹åº”çš„åˆ—è¡¨
            if (type === 'observation') loadObservationSurveys();
            else if (type === 'interference') loadInterferenceSurveys();
            else if (type === 'behavior') loadBehaviorSurveys();
        }
        
        // åˆ é™¤åˆ†æ¡è®°å½•
        function deleteEntry(type, surveyId, entryId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡è®°å½•å—ï¼Ÿ')) {
                return;
            }
            
            let key;
            if (type === 'observation') key = 'observationSurveys';
            else if (type === 'interference') key = 'interferenceSurveys';
            else if (type === 'behavior') key = 'behaviorSurveys';
            else return;
            
            let surveys = JSON.parse(localStorage.getItem(key) || '[]');
            const surveyIndex = surveys.findIndex(s => s.id === surveyId);
            
            if (surveyIndex !== -1) {
                surveys[surveyIndex].entries = surveys[surveyIndex].entries.filter(e => e.id !== entryId);
                localStorage.setItem(key, JSON.stringify(surveys));
                
                showSaveIndicator();
                
                // é‡æ–°æ’åºç¼–å·ï¼ˆå¦‚æœæ˜¯é«˜é“å¹²æ‰°æˆ–é¸Ÿç±»è¡Œä¸ºï¼‰
                if (type === 'interference') {
                    reorderInterferenceIds(surveyId);
                } else if (type === 'behavior') {
                    reorderBehaviorIds(surveyId);
                }
                
                // é‡æ–°åŠ è½½å¯¹åº”çš„åˆ†æ¡è®°å½•
                if (type === 'observation') loadObservationEntries(surveyId);
                else if (type === 'interference') loadInterferenceEntries(surveyId);
                else if (type === 'behavior') loadBehaviorEntries(surveyId);
            }
        }
        
        // å¯¼å‡ºæ‰€æœ‰è§‚æµ‹å¯¹è±¡è®°å½•
        function exportAllObservation() {
            const surveys = JSON.parse(localStorage.getItem('observationSurveys') || '[]');
            if (surveys.length === 0) {
                alert('æš‚æ— è§‚æµ‹å¯¹è±¡è®°å½•å¯å¯¼å‡º');
                return;
            }
            
            // æ˜¾ç¤ºå¯¼å‡ºæç¤º
            showExportIndicator();
            
            // åˆ›å»ºCSVå†…å®¹
            let csvContent = "data:text/csv;charset=utf-8,\uFEFF";
            
            // éå†æ‰€æœ‰è°ƒç ”è®°å½•
            surveys.forEach((survey, index) => {
                csvContent += `"è§‚æµ‹å¯¹è±¡è°ƒç ”è®°å½•ä¿¡æ¯"\n`;
                csvContent += `"è§‚æµ‹åœ°","${survey.site}"\n`;
                csvContent += `"æ—¥æœŸ","${survey.date}"\n`;
                csvContent += `"è®°å½•æ•°é‡","${survey.entries ? survey.entries.length : 0}"\n`;
                csvContent += `\n`;
                csvContent += `"å¯¹è±¡ç¼–å·","å…·ä½“ç§å","æ´»åŠ¨è§„æ¨¡","ä½ç½®ä¸è½¨è¿¹ç¼–å·","å¤©æ°”æƒ…å†µ","è§‚æµ‹å¼€å§‹æ—¶é—´","è§‚æµ‹ç»“æŸæ—¶é—´"\n`;
                
                // æ·»åŠ æ•°æ®è¡Œ
                if (survey.entries && survey.entries.length > 0) {
                    survey.entries.forEach(entry => {
                        csvContent += `"${entry.objectId || ''}","${entry.species || ''}","${entry.activityScale || ''}","${entry.location || ''}","${entry.weather || ''}","${entry.startTime || ''}","${entry.endTime || ''}"\n`;
                    });
                } else {
                    csvContent += `"æš‚æ— è®°å½•","","","","","",""\n`;
                }
                
                // æ·»åŠ åˆ†é¡µç¬¦ï¼ˆå¤šä¸ªè°ƒç ”è®°å½•ä¹‹é—´ï¼‰
                if (index < surveys.length - 1) {
                    csvContent += `\n\n`;
                }
            });
            
            // åˆ›å»ºä¸‹è½½é“¾æ¥
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            const fileName = `è§‚æµ‹å¯¹è±¡è®°å½•_${new Date().toISOString().split('T')[0]}.csv`;
            link.setAttribute("download", fileName);
            document.body.appendChild(link);
            
            // è§¦å‘ä¸‹è½½
            link.click();
            document.body.removeChild(link);
            
            // æ˜¾ç¤ºå¯¼å‡ºæˆåŠŸæç¤º
            setTimeout(() => {
                showSaveIndicator();
            }, 1000);
        }
        
        // å¯¼å‡ºå½“å‰è§‚æµ‹å¯¹è±¡è®°å½•
        function exportObservationEntries() {
            if (!appState.currentSurvey.observation) {
                alert('è¯·å…ˆé€‰æ‹©è°ƒç ”è®°å½•');
                return;
            }
            
            const surveys = JSON.parse(localStorage.getItem('observationSurveys') || '[]');
            const survey = surveys.find(s => s.id === appState.currentSurvey.observation);
            
            if (!survey || !survey.entries || survey.entries.length === 0) {
                alert('å½“å‰è°ƒç ”è®°å½•æš‚æ— æ•°æ®å¯å¯¼å‡º');
                return;
            }
            
            // æ˜¾ç¤ºå¯¼å‡ºæç¤º
            showExportIndicator();
            
            // åˆ›å»ºCSVå†…å®¹
            let csvContent = "data:text/csv;charset=utf-8,\uFEFF";
            
            // æ·»åŠ è°ƒç ”è®°å½•ä¿¡æ¯
            csvContent += `"è§‚æµ‹å¯¹è±¡è°ƒç ”è®°å½•ä¿¡æ¯"\n`;
            csvContent += `"è§‚æµ‹åœ°","${survey.site}"\n`;
            csvContent += `"æ—¥æœŸ","${survey.date}"\n`;
            csvContent += `"è®°å½•æ•°é‡","${survey.entries.length}"\n`;
            csvContent += `\n`;
            csvContent += `"å¯¹è±¡ç¼–å·","å…·ä½“ç§å","æ´»åŠ¨è§„æ¨¡","ä½ç½®ä¸è½¨è¿¹ç¼–å·","å¤©æ°”æƒ…å†µ","è§‚æµ‹å¼€å§‹æ—¶é—´","è§‚æµ‹ç»“æŸæ—¶é—´"\n`;
            
            // æ·»åŠ æ•°æ®è¡Œ
            survey.entries.forEach(entry => {
                csvContent += `"${entry.objectId || ''}","${entry.species || ''}","${entry.activityScale || ''}","${entry.location || ''}","${entry.weather || ''}","${entry.startTime || ''}","${entry.endTime || ''}"\n`;
            });
            
            // åˆ›å»ºä¸‹è½½é“¾æ¥
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            const fileName = `è§‚æµ‹å¯¹è±¡è®°å½•_${survey.site}_${survey.date}.csv`;
            link.setAttribute("download", fileName);
            document.body.appendChild(link);
            
            // è§¦å‘ä¸‹è½½
            link.click();
            document.body.removeChild(link);
            
            // æ˜¾ç¤ºå¯¼å‡ºæˆåŠŸæç¤º
            setTimeout(() => {
                showSaveIndicator();
            }, 1000);
        }
        
        // å¯¼å‡ºæ‰€æœ‰é«˜é“å¹²æ‰°è®°å½•
        function exportAllInterference() {
            const surveys = JSON.parse(localStorage.getItem('interferenceSurveys') || '[]');
            if (surveys.length === 0) {
                alert('æš‚æ— é«˜é“å¹²æ‰°è®°å½•å¯å¯¼å‡º');
                return;
            }
            
            // æ˜¾ç¤ºå¯¼å‡ºæç¤º
            showExportIndicator();
            
            // åˆ›å»ºCSVå†…å®¹
            let csvContent = "data:text/csv;charset=utf-8,\uFEFF";
            
            // éå†æ‰€æœ‰è°ƒç ”è®°å½•
            surveys.forEach((survey, index) => {
                csvContent += `"é«˜é“å¹²æ‰°è°ƒç ”è®°å½•ä¿¡æ¯"\n`;
                csvContent += `"è§‚æµ‹åœ°","${survey.site}"\n`;
                csvContent += `"æ—¥æœŸ","${survey.date}"\n`;
                csvContent += `"è®°å½•æ•°é‡","${survey.entries ? survey.entries.length : 0}"\n`;
                csvContent += `\n`;
                csvContent += `"é«˜é“å¹²æ‰°äº‹ä»¶ç¼–å·","è½¦å¢èŠ‚æ•°","ç»è¿‡æ—¶é—´"\n`;
                
                // æ·»åŠ æ•°æ®è¡Œ
                if (survey.entries && survey.entries.length > 0) {
                    survey.entries.forEach(entry => {
                        csvContent += `"${entry.interferenceId || ''}","${entry.carriageCount || ''}","${entry.passingTime || ''}"\n`;
                    });
                } else {
                    csvContent += `"æš‚æ— è®°å½•","",""\n`;
                }
                
                // æ·»åŠ åˆ†é¡µç¬¦ï¼ˆå¤šä¸ªè°ƒç ”è®°å½•ä¹‹é—´ï¼‰
                if (index < surveys.length - 1) {
                    csvContent += `\n\n`;
                }
            });
            
            // åˆ›å»ºä¸‹è½½é“¾æ¥
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            const fileName = `é«˜é“å¹²æ‰°è®°å½•_${new Date().toISOString().split('T')[0]}.csv`;
            link.setAttribute("download", fileName);
            document.body.appendChild(link);
            
            // è§¦å‘ä¸‹è½½
            link.click();
            document.body.removeChild(link);
            
            // æ˜¾ç¤ºå¯¼å‡ºæˆåŠŸæç¤º
            setTimeout(() => {
                showSaveIndicator();
            }, 1000);
        }
        
        // å¯¼å‡ºå½“å‰é«˜é“å¹²æ‰°è®°å½•
        function exportInterferenceEntries() {
            if (!appState.currentSurvey.interference) {
                alert('è¯·å…ˆé€‰æ‹©è°ƒç ”è®°å½•');
                return;
            }
            
            const surveys = JSON.parse(localStorage.getItem('interferenceSurveys') || '[]');
            const survey = surveys.find(s => s.id === appState.currentSurvey.interference);
            
            if (!survey || !survey.entries || survey.entries.length === 0) {
                alert('å½“å‰è°ƒç ”è®°å½•æš‚æ— æ•°æ®å¯å¯¼å‡º');
                return;
            }
            
            // æ˜¾ç¤ºå¯¼å‡ºæç¤º
            showExportIndicator();
            
            // åˆ›å»ºCSVå†…å®¹
            let csvContent = "data:text/csv;charset=utf-8,\uFEFF";
            
            // æ·»åŠ è°ƒç ”è®°å½•ä¿¡æ¯
            csvContent += `"é«˜é“å¹²æ‰°è°ƒç ”è®°å½•ä¿¡æ¯"\n`;
            csvContent += `"è§‚æµ‹åœ°","${survey.site}"\n`;
            csvContent += `"æ—¥æœŸ","${survey.date}"\n`;
            csvContent += `"è®°å½•æ•°é‡","${survey.entries.length}"\n`;
            csvContent += `\n`;
            csvContent += `"é«˜é“å¹²æ‰°äº‹ä»¶ç¼–å·","è½¦å¢èŠ‚æ•°","ç»è¿‡æ—¶é—´"\n`;
            
            // æ·»åŠ æ•°æ®è¡Œ
            survey.entries.forEach(entry => {
                csvContent += `"${entry.interferenceId || ''}","${entry.carriageCount || ''}","${entry.passingTime || ''}"\n`;
            });
            
            // åˆ›å»ºä¸‹è½½é“¾æ¥
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            const fileName = `é«˜é“å¹²æ‰°è®°å½•_${survey.site}_${survey.date}.csv`;
            link.setAttribute("download", fileName);
            document.body.appendChild(link);
            
            // è§¦å‘ä¸‹è½½
            link.click();
            document.body.removeChild(link);
            
            // æ˜¾ç¤ºå¯¼å‡ºæˆåŠŸæç¤º
            setTimeout(() => {
                showSaveIndicator();
            }, 1000);
        }
        
        // å¯¼å‡ºæ‰€æœ‰é¸Ÿç±»è¡Œä¸ºè®°å½•
        function exportAllBehavior() {
            const surveys = JSON.parse(localStorage.getItem('behaviorSurveys') || '[]');
            if (surveys.length === 0) {
                alert('æš‚æ— é¸Ÿç±»è¡Œä¸ºè®°å½•å¯å¯¼å‡º');
                return;
            }
            
            // æ˜¾ç¤ºå¯¼å‡ºæç¤º
            showExportIndicator();
            
            // åˆ›å»ºCSVå†…å®¹
            let csvContent = "data:text/csv;charset=utf-8,\uFEFF";
            
            // éå†æ‰€æœ‰è°ƒç ”è®°å½•
            surveys.forEach((survey, index) => {
                csvContent += `"é¸Ÿç±»è¡Œä¸ºè°ƒç ”è®°å½•ä¿¡æ¯"\n`;
                csvContent += `"è§‚æµ‹åœ°","${survey.site}"\n`;
                csvContent += `"æ—¥æœŸ","${survey.date}"\n`;
                csvContent += `"è§‚æµ‹å¯¹è±¡ç¼–å·","${survey.objectId || 'æœªå¡«å†™'}"\n`;
                csvContent += `"è®°å½•æ•°é‡","${survey.entries ? survey.entries.length : 0}"\n`;
                csvContent += `\n`;
                csvContent += `"è¡Œä¸ºè®°å½•ç¼–å·","è¡Œä¸º/åˆ†å¸ƒ","å‘ç”Ÿæ—¶é—´"\n`;
                
                // æ·»åŠ æ•°æ®è¡Œ
                if (survey.entries && survey.entries.length > 0) {
                    // æŒ‰æ—¶é—´æˆ³æ’åº
                    const sortedEntries = [...survey.entries].sort((a, b) => a.timestamp - b.timestamp);
                    
                    sortedEntries.forEach(entry => {
                        csvContent += `"${entry.id || ''}","${entry.behavior || ''}","${entry.time || ''}"\n`;
                    });
                } else {
                    csvContent += `"æš‚æ— è®°å½•","",""\n`;
                }
                
                // æ·»åŠ åˆ†é¡µç¬¦ï¼ˆå¤šä¸ªè°ƒç ”è®°å½•ä¹‹é—´ï¼‰
                if (index < surveys.length - 1) {
                    csvContent += `\n\n`;
                }
            });
            
            // åˆ›å»ºä¸‹è½½é“¾æ¥
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            const fileName = `é¸Ÿç±»è¡Œä¸ºè®°å½•_${new Date().toISOString().split('T')[0]}.csv`;
            link.setAttribute("download", fileName);
            document.body.appendChild(link);
            
            // è§¦å‘ä¸‹è½½
            link.click();
            document.body.removeChild(link);
            
            // æ˜¾ç¤ºå¯¼å‡ºæˆåŠŸæç¤º
            setTimeout(() => {
                showSaveIndicator();
            }, 1000);
        }
        
        // å¯¼å‡ºå½“å‰é¸Ÿç±»è¡Œä¸ºè®°å½•
        function exportBehaviorEntries() {
            if (!appState.currentSurvey.behavior) {
                alert('è¯·å…ˆé€‰æ‹©è°ƒç ”è®°å½•');
                return;
            }
            
            const surveys = JSON.parse(localStorage.getItem('behaviorSurveys') || '[]');
            const survey = surveys.find(s => s.id === appState.currentSurvey.behavior);
            
            if (!survey || !survey.entries || survey.entries.length === 0) {
                alert('å½“å‰è°ƒç ”è®°å½•æš‚æ— æ•°æ®å¯å¯¼å‡º');
                return;
            }
            
            // æ˜¾ç¤ºå¯¼å‡ºæç¤º
            showExportIndicator();
            
            // åˆ›å»ºCSVå†…å®¹
            let csvContent = "data:text/csv;charset=utf-8,\uFEFF";
            
            // æ·»åŠ è°ƒç ”è®°å½•ä¿¡æ¯
            csvContent += `"é¸Ÿç±»è¡Œä¸ºè°ƒç ”è®°å½•ä¿¡æ¯"\n`;
            csvContent += `"è§‚æµ‹åœ°","${survey.site}"\n`;
            csvContent += `"æ—¥æœŸ","${survey.date}"\n`;
            csvContent += `"è§‚æµ‹å¯¹è±¡ç¼–å·","${survey.objectId || 'æœªå¡«å†™'}"\n`;
            csvContent += `"è®°å½•æ•°é‡","${survey.entries.length}"\n`;
            csvContent += `\n`;
            csvContent += `"è¡Œä¸ºè®°å½•ç¼–å·","è¡Œä¸º/åˆ†å¸ƒ","å‘ç”Ÿæ—¶é—´"\n`;
            
            // æ·»åŠ æ•°æ®è¡Œï¼ˆæŒ‰æ—¶é—´é¡ºåºï¼‰
            const sortedEntries = [...survey.entries].sort((a, b) => a.timestamp - b.timestamp);
            sortedEntries.forEach(entry => {
                csvContent += `"${entry.id || ''}","${entry.behavior || ''}","${entry.time || ''}"\n`;
            });
            
            // åˆ›å»ºä¸‹è½½é“¾æ¥
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            const fileName = `é¸Ÿç±»è¡Œä¸ºè®°å½•_${survey.site}_${survey.date}.csv`;
            link.setAttribute("download", fileName);
            document.body.appendChild(link);
            
            // è§¦å‘ä¸‹è½½
            link.click();
            document.body.removeChild(link);
            
            // æ˜¾ç¤ºå¯¼å‡ºæˆåŠŸæç¤º
            setTimeout(() => {
                showSaveIndicator();
            }, 1000);
        }
        
        // åŠ è½½æ‰€æœ‰æ•°æ®
        function loadAllData() {
            loadObservationSurveys();
            loadInterferenceSurveys();
            loadBehaviorSurveys();
        }
        
        // åŠ è½½è§‚æµ‹å¯¹è±¡è°ƒç ”è®°å½•
        function loadObservationSurveys() {
            const surveys = JSON.parse(localStorage.getItem('observationSurveys') || '[]');
            const container = document.getElementById('observation-survey-list');
            
            if (surveys.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <p>æš‚æ— è§‚æµ‹å¯¹è±¡è°ƒç ”è®°å½•</p>
                        <p>ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®åˆ›å»ºæ–°çš„è°ƒç ”è®°å½•</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = surveys.map(survey => `
                <div class="survey-item">
                    <div class="survey-info">
                        <div class="survey-site">è§‚æµ‹åœ°: ${survey.site}</div>
                        <div class="survey-date">æ—¥æœŸ: ${survey.date}</div>
                        <div class="survey-entries-count">è®°å½•æ¡æ•°: ${survey.entries ? survey.entries.length : 0}</div>
                    </div>
                    <div>
                        <button class="export-btn" onclick="exportSingleObservation('${survey.id}')" title="å¯¼å‡ºæ­¤è°ƒç ”è®°å½•">
                            ğŸ“¤
                        </button>
                        <button class="delete-btn" onclick="deleteSurvey('observation', '${survey.id}')" title="åˆ é™¤æ­¤è°ƒç ”è®°å½•">
                            ğŸ—‘ï¸
                        </button>
                        <button class="time-btn" onclick="enterObservationEntries('${survey.id}')" style="margin-top: 10px;">
                            æŸ¥çœ‹/ç¼–è¾‘
                        </button>
                    </div>
                </div>
            `).join('');
        }
        
        // å¯¼å‡ºå•ä¸ªè§‚æµ‹å¯¹è±¡è°ƒç ”è®°å½•
        function exportSingleObservation(surveyId) {
            const surveys = JSON.parse(localStorage.getItem('observationSurveys') || '[]');
            const survey = surveys.find(s => s.id === surveyId);
            
            if (!survey) {
                alert('è°ƒç ”è®°å½•ä¸å­˜åœ¨');
                return;
            }
            
            // æ˜¾ç¤ºå¯¼å‡ºæç¤º
            showExportIndicator();
            
            // åˆ›å»ºCSVå†…å®¹
            let csvContent = "data:text/csv;charset=utf-8,\uFEFF";
            
            // æ·»åŠ è°ƒç ”è®°å½•ä¿¡æ¯
            csvContent += `"è§‚æµ‹å¯¹è±¡è°ƒç ”è®°å½•ä¿¡æ¯"\n`;
            csvContent += `"è§‚æµ‹åœ°","${survey.site}"\n`;
            csvContent += `"æ—¥æœŸ","${survey.date}"\n`;
            csvContent += `"è®°å½•æ•°é‡","${survey.entries ? survey.entries.length : 0}"\n`;
            csvContent += `\n`;
            csvContent += `"å¯¹è±¡ç¼–å·","å…·ä½“ç§å","æ´»åŠ¨è§„æ¨¡","ä½ç½®ä¸è½¨è¿¹ç¼–å·","å¤©æ°”æƒ…å†µ","è§‚æµ‹å¼€å§‹æ—¶é—´","è§‚æµ‹ç»“æŸæ—¶é—´"\n`;
            
            // æ·»åŠ æ•°æ®è¡Œ
            if (survey.entries && survey.entries.length > 0) {
                survey.entries.forEach(entry => {
                    csvContent += `"${entry.objectId || ''}","${entry.species || ''}","${entry.activityScale || ''}","${entry.location || ''}","${entry.weather || ''}","${entry.startTime || ''}","${entry.endTime || ''}"\n`;
                });
            } else {
                csvContent += `"æš‚æ— è®°å½•","","","","","",""\n`;
            }
            
            // åˆ›å»ºä¸‹è½½é“¾æ¥
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            const fileName = `è§‚æµ‹å¯¹è±¡è®°å½•_${survey.site}_${survey.date}.csv`;
            link.setAttribute("download", fileName);
            document.body.appendChild(link);
            
            // è§¦å‘ä¸‹è½½
            link.click();
            document.body.removeChild(link);
            
            // æ˜¾ç¤ºå¯¼å‡ºæˆåŠŸæç¤º
            setTimeout(() => {
                showSaveIndicator();
            }, 1000);
        }
        
        // åŠ è½½è§‚æµ‹å¯¹è±¡åˆ†æ¡è®°å½•
        function loadObservationEntries(surveyId) {
            const surveys = JSON.parse(localStorage.getItem('observationSurveys') || '[]');
            const survey = surveys.find(s => s.id === surveyId);
            const container = document.getElementById('observation-entry-list');
            
            if (!survey || !survey.entries || survey.entries.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <p>æš‚æ— è§‚æµ‹å¯¹è±¡è®°å½•</p>
                        <p>ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®åˆ›å»ºæ–°çš„è®°å½•</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = survey.entries.map(entry => `
                <div class="entry-item">
                    <div class="entry-header">
                        <div class="entry-id">${entry.objectId}</div>
                        <button class="delete-btn" onclick="deleteEntry('observation', '${surveyId}', '${entry.id}')">
                            ğŸ—‘ï¸
                        </button>
                    </div>
                    <div class="entry-details">
                        <div><strong>ç§å:</strong> ${entry.species}</div>
                        <div><strong>æ´»åŠ¨è§„æ¨¡:</strong> ${entry.activityScale}</div>
                        <div><strong>ä½ç½®ä¸è½¨è¿¹ç¼–å·:</strong> ${entry.location}</div>
                        <div><strong>å¤©æ°”æƒ…å†µ:</strong> ${entry.weather}</div>
                        <div><strong>è§‚æµ‹æ—¶é—´:</strong> ${entry.startTime} - ${entry.endTime}</div>
                    </div>
                </div>
            `).join('');
        }
        
        // åŠ è½½é«˜é“å¹²æ‰°è°ƒç ”è®°å½•
        function loadInterferenceSurveys() {
            const surveys = JSON.parse(localStorage.getItem('interferenceSurveys') || '[]');
            const container = document.getElementById('interference-survey-list');
            
            if (surveys.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <p>æš‚æ— é«˜é“å¹²æ‰°è°ƒç ”è®°å½•</p>
                        <p>ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®åˆ›å»ºæ–°çš„è°ƒç ”è®°å½•</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = surveys.map(survey => `
                <div class="survey-item">
                    <div class="survey-info">
                        <div class="survey-site">è§‚æµ‹åœ°: ${survey.site}</div>
                        <div class="survey-date">æ—¥æœŸ: ${survey.date}</div>
                        <div class="survey-entries-count">è®°å½•æ¡æ•°: ${survey.entries ? survey.entries.length : 0}</div>
                    </div>
                    <div>
                        <button class="export-btn" onclick="exportSingleInterference('${survey.id}')" title="å¯¼å‡ºæ­¤è°ƒç ”è®°å½•">
                            ğŸ“¤
                        </button>
                        <button class="delete-btn" onclick="deleteSurvey('interference', '${survey.id}')" title="åˆ é™¤æ­¤è°ƒç ”è®°å½•">
                            ğŸ—‘ï¸
                        </button>
                        <button class="time-btn" onclick="enterInterferenceEntries('${survey.id}')" style="margin-top: 10px;">
                            æŸ¥çœ‹/ç¼–è¾‘
                        </button>
                    </div>
                </div>
            `).join('');
        }
        
        // å¯¼å‡ºå•ä¸ªé«˜é“å¹²æ‰°è°ƒç ”è®°å½•
        function exportSingleInterference(surveyId) {
            const surveys = JSON.parse(localStorage.getItem('interferenceSurveys') || '[]');
            const survey = surveys.find(s => s.id === surveyId);
            
            if (!survey) {
                alert('è°ƒç ”è®°å½•ä¸å­˜åœ¨');
                return;
            }
            
            // æ˜¾ç¤ºå¯¼å‡ºæç¤º
            showExportIndicator();
            
            // åˆ›å»ºCSVå†…å®¹
            let csvContent = "data:text/csv;charset=utf-8,\uFEFF";
            
            // æ·»åŠ è°ƒç ”è®°å½•ä¿¡æ¯
            csvContent += `"é«˜é“å¹²æ‰°è°ƒç ”è®°å½•ä¿¡æ¯"\n`;
            csvContent += `"è§‚æµ‹åœ°","${survey.site}"\n`;
            csvContent += `"æ—¥æœŸ","${survey.date}"\n`;
            csvContent += `"è®°å½•æ•°é‡","${survey.entries ? survey.entries.length : 0}"\n`;
            csvContent += `\n`;
            csvContent += `"é«˜é“å¹²æ‰°äº‹ä»¶ç¼–å·","è½¦å¢èŠ‚æ•°","ç»è¿‡æ—¶é—´"\n`;
            
            // æ·»åŠ æ•°æ®è¡Œ
            if (survey.entries && survey.entries.length > 0) {
                survey.entries.forEach(entry => {
                    csvContent += `"${entry.interferenceId || ''}","${entry.carriageCount || ''}","${entry.passingTime || ''}"\n`;
                });
            } else {
                csvContent += `"æš‚æ— è®°å½•","",""\n`;
            }
            
            // åˆ›å»ºä¸‹è½½é“¾æ¥
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            const fileName = `é«˜é“å¹²æ‰°è®°å½•_${survey.site}_${survey.date}.csv`;
            link.setAttribute("download", fileName);
            document.body.appendChild(link);
            
            // è§¦å‘ä¸‹è½½
            link.click();
            document.body.removeChild(link);
            
            // æ˜¾ç¤ºå¯¼å‡ºæˆåŠŸæç¤º
            setTimeout(() => {
                showSaveIndicator();
            }, 1000);
        }
        
        // åŠ è½½é«˜é“å¹²æ‰°åˆ†æ¡è®°å½•
        function loadInterferenceEntries(surveyId) {
            const surveys = JSON.parse(localStorage.getItem('interferenceSurveys') || '[]');
            const survey = surveys.find(s => s.id === surveyId);
            const container = document.getElementById('interference-entry-list');
            
            if (!survey || !survey.entries || survey.entries.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <p>æš‚æ— é«˜é“å¹²æ‰°è®°å½•</p>
                        <p>ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®åˆ›å»ºæ–°çš„è®°å½•</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = survey.entries.map(entry => `
                <div class="entry-item">
                    <div class="entry-header">
                        <div class="entry-id">${entry.interferenceId}</div>
                        <button class="delete-btn" onclick="deleteEntry('interference', '${surveyId}', '${entry.id}')">
                            ğŸ—‘ï¸
                        </button>
                    </div>
                    <div class="entry-details">
                        <div><strong>è½¦å¢èŠ‚æ•°:</strong> ${entry.carriageCount}</div>
                        <div><strong>ç»è¿‡æ—¶é—´:</strong> ${entry.passingTime}</div>
                    </div>
                </div>
            `).join('');
        }
        
        // åŠ è½½é¸Ÿç±»è¡Œä¸ºè°ƒç ”è®°å½• - æ›´æ–°ä¸ºåŒ…å«è§‚æµ‹å¯¹è±¡ç¼–å·
        function loadBehaviorSurveys() {
            const surveys = JSON.parse(localStorage.getItem('behaviorSurveys') || '[]');
            const container = document.getElementById('behavior-survey-list');
            
            if (surveys.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <p>æš‚æ— é¸Ÿç±»è¡Œä¸ºè°ƒç ”è®°å½•</p>
                        <p>ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®åˆ›å»ºæ–°çš„è°ƒç ”è®°å½•</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = surveys.map(survey => `
                <div class="survey-item">
                    <div class="survey-info">
                        <div class="survey-site">è§‚æµ‹åœ°: ${survey.site}</div>
                        <div class="survey-date">æ—¥æœŸ: ${survey.date}</div>
                        <div class="survey-entries-count">è®°å½•æ¡æ•°: ${survey.entries ? survey.entries.length : 0}</div>
                        ${survey.objectId ? `<div class="survey-entries-count">è§‚æµ‹å¯¹è±¡: ${survey.objectId}</div>` : ''}
                    </div>
                    <div>
                        <button class="export-btn" onclick="exportSingleBehavior('${survey.id}')" title="å¯¼å‡ºæ­¤è°ƒç ”è®°å½•">
                            ğŸ“¤
                        </button>
                        <button class="delete-btn" onclick="deleteSurvey('behavior', '${survey.id}')" title="åˆ é™¤æ­¤è°ƒç ”è®°å½•">
                            ğŸ—‘ï¸
                        </button>
                        <button class="time-btn" onclick="enterBehaviorEntries('${survey.id}')" style="margin-top: 10px;">
                            æŸ¥çœ‹/ç¼–è¾‘
                        </button>
                    </div>
                </div>
            `).join('');
        }
        
        // å¯¼å‡ºå•ä¸ªé¸Ÿç±»è¡Œä¸ºè°ƒç ”è®°å½• - æ›´æ–°ä¸ºåŒ…å«è§‚æµ‹å¯¹è±¡ç¼–å·
        function exportSingleBehavior(surveyId) {
            const surveys = JSON.parse(localStorage.getItem('behaviorSurveys') || '[]');
            const survey = surveys.find(s => s.id === surveyId);
            
            if (!survey) {
                alert('è°ƒç ”è®°å½•ä¸å­˜åœ¨');
                return;
            }
            
            // æ˜¾ç¤ºå¯¼å‡ºæç¤º
            showExportIndicator();
            
            // åˆ›å»ºCSVå†…å®¹
            let csvContent = "data:text/csv;charset=utf-8,\uFEFF";
            
            // æ·»åŠ è°ƒç ”è®°å½•ä¿¡æ¯
            csvContent += `"é¸Ÿç±»è¡Œä¸ºè°ƒç ”è®°å½•ä¿¡æ¯"\n`;
            csvContent += `"è§‚æµ‹åœ°","${survey.site}"\n`;
            csvContent += `"æ—¥æœŸ","${survey.date}"\n`;
            csvContent += `"è§‚æµ‹å¯¹è±¡ç¼–å·","${survey.objectId || 'æœªå¡«å†™'}"\n`;
            csvContent += `"è®°å½•æ•°é‡","${survey.entries ? survey.entries.length : 0}"\n`;
            csvContent += `\n`;
            csvContent += `"è¡Œä¸ºè®°å½•ç¼–å·","è¡Œä¸º/åˆ†å¸ƒ","å‘ç”Ÿæ—¶é—´"\n`;
            
            // æ·»åŠ æ•°æ®è¡Œ
            if (survey.entries && survey.entries.length > 0) {
                // æŒ‰æ—¶é—´é¡ºåºæ’åº
                const sortedEntries = [...survey.entries].sort((a, b) => a.timestamp - b.timestamp);
                
                sortedEntries.forEach(entry => {
                    csvContent += `"${entry.id || ''}","${entry.behavior || ''}","${entry.time || ''}"\n`;
                });
            } else {
                csvContent += `"æš‚æ— è®°å½•","",""\n`;
            }
            
            // åˆ›å»ºä¸‹è½½é“¾æ¥
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            const fileName = `é¸Ÿç±»è¡Œä¸ºè®°å½•_${survey.site}_${survey.date}.csv`;
            link.setAttribute("download", fileName);
            document.body.appendChild(link);
            
            // è§¦å‘ä¸‹è½½
            link.click();
            document.body.removeChild(link);
            
            // æ˜¾ç¤ºå¯¼å‡ºæˆåŠŸæç¤º
            setTimeout(() => {
                showSaveIndicator();
            }, 1000);
        }
        
        // åŠ è½½é¸Ÿç±»è¡Œä¸ºè®°å½•
        function loadBehaviorEntries(surveyId) {
            const surveys = JSON.parse(localStorage.getItem('behaviorSurveys') || '[]');
            const survey = surveys.find(s => s.id === surveyId);
            const container = document.getElementById('behavior-entry-list');
            
            if (!survey || !survey.entries || survey.entries.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <p>æš‚æ— é¸Ÿç±»è¡Œä¸ºè®°å½•</p>
                        <p>ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®è®°å½•è¡Œä¸º</p>
                    </div>
                `;
                return;
            }
            
            // æŒ‰æ—¶é—´æˆ³æ’åºï¼ˆæœ€æ–°çš„åœ¨å‰ï¼‰
            const sortedEntries = [...survey.entries].sort((a, b) => b.timestamp - a.timestamp);
            
            container.innerHTML = sortedEntries.map(entry => `
                <div class="entry-item">
                    <div class="entry-header">
                        <div class="entry-id">${entry.id}</div>
                        <button class="delete-btn" onclick="deleteEntry('behavior', '${surveyId}', '${entry.id}')">
                            ğŸ—‘ï¸
                        </button>
                    </div>
                    <div class="entry-details">
                        <div><strong>è¡Œä¸º/åˆ†å¸ƒ:</strong> ${entry.behavior}</div>
                        <div><strong>å‘ç”Ÿæ—¶é—´:</strong> ${entry.time}</div>
                    </div>
                </div>
            `).join('');
        }
        
        // æ˜¾ç¤ºä¿å­˜æç¤º
        function showSaveIndicator() {
            const indicator = document.getElementById('save-indicator');
            indicator.style.display = 'block';
            
            setTimeout(() => {
                indicator.style.display = 'none';
            }, 2000);
        }
        
        // æ˜¾ç¤ºå¯¼å‡ºæç¤º
        function showExportIndicator() {
            const indicator = document.getElementById('export-indicator');
            indicator.style.display = 'block';
            
            setTimeout(() => {
                indicator.style.display = 'none';
            }, 3000);
        }
        
        // ä½¿å‡½æ•°åœ¨å…¨å±€å¯è®¿é—®
        window.deleteSurvey = deleteSurvey;
        window.deleteEntry = deleteEntry;
        window.enterObservationEntries = enterObservationEntries;
        window.enterInterferenceEntries = enterInterferenceEntries;
        window.enterBehaviorEntries = enterBehaviorEntries;
        window.exportSingleObservation = exportSingleObservation;
        window.exportSingleInterference = exportSingleInterference;
        window.exportSingleBehavior = exportSingleBehavior;
    </script>
</body>
</html>